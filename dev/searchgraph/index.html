<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>SearchGraph · SimilaritySearch.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link rel="canonical" href="https://sadit.github.io/SimilaritySearch.jl/searchgraph/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">SimilaritySearch.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../searching/">Searching</a></li><li class="is-active"><a class="tocitem" href>SearchGraph</a><ul class="internal"><li><a class="tocitem" href="#Local-search-algorithms"><span>Local search algorithms</span></a></li><li><a class="tocitem" href="#Neighborhood-algorithms"><span>Neighborhood algorithms</span></a></li><li><a class="tocitem" href="#Incremental-construction-of-the-index"><span>Incremental construction of the index</span></a></li></ul></li><li><span class="tocitem">API</span><ul><li><a class="tocitem" href="../knnresult/">Knn results</a></li><li><a class="tocitem" href="../distminkowski/">Minkowski distances</a></li><li><a class="tocitem" href="../distcos/">Cosine and angle distances</a></li><li><a class="tocitem" href="../diststrings/">String alignments</a></li><li><a class="tocitem" href="../disthamming/">Hamming distances</a></li><li><a class="tocitem" href="../distsets/">Sets distances</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>SearchGraph</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>SearchGraph</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/sadit/SimilaritySearch.jl/blob/master/docs/src/searchgraph.md#L" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><p><code>SearchGraph</code> creates a graph</p><p><em>Tellez, E. S., Ruiz, G., Chavez, E., &amp; Graff, M.A scalable solution to the nearest neighbor search problem through local-search methods on neighbor graphs. Pattern Analysis and Applications, 1-15.</em></p><p>As before, we need a dataset <span>$X$</span> and a distance function.</p><pre><code class="language-julia hljs">using SimilaritySearch
X = [randn(3) for i in 1:10_000]
Q = [randn(3) for i in 1:5]


index = SearchGraph(; dist=L2Distance(), verbose=true)
append!(index, X)

for q in Q
    println(search(index, q, KnnResult(3)))
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">calling callback DisjointHints at n=11
calling callback NeighborhoodSize at n=11
calling callback DisjointHints at n=17
calling callback NeighborhoodSize at n=17
calling callback DisjointHints at n=25
calling callback NeighborhoodSize at n=25
calling callback DisjointHints at n=38
calling callback NeighborhoodSize at n=38
calling callback DisjointHints at n=57
calling callback NeighborhoodSize at n=57
calling callback DisjointHints at n=86
calling callback NeighborhoodSize at n=86
calling callback DisjointHints at n=129
calling callback NeighborhoodSize at n=129
calling callback DisjointHints at n=194
calling callback NeighborhoodSize at n=194
calling callback DisjointHints at n=291
calling callback NeighborhoodSize at n=291
calling callback DisjointHints at n=437
calling callback NeighborhoodSize at n=437
calling callback DisjointHints at n=656
calling callback NeighborhoodSize at n=656
calling callback DisjointHints at n=985
calling callback NeighborhoodSize at n=985
calling callback DisjointHints at n=1477
calling callback NeighborhoodSize at n=1477
calling callback DisjointHints at n=2216
calling callback NeighborhoodSize at n=2216
calling callback DisjointHints at n=3325
calling callback NeighborhoodSize at n=3325
calling callback DisjointHints at n=4987
calling callback NeighborhoodSize at n=4987
calling callback DisjointHints at n=7481
calling callback NeighborhoodSize at n=7481
(res = KnnResult(Int32[9565, 8579, 2558], Float32[0.09848699, 0.159677, 0.16358984], 3), cost = 214)
(res = KnnResult(Int32[442, 8128, 305], Float32[0.037119858, 0.10394967, 0.1074205], 3), cost = 231)
(res = KnnResult(Int32[3591, 5478, 3478], Float32[0.04747759, 0.08438669, 0.11445825], 3), cost = 237)
(res = KnnResult(Int32[9747, 6816, 1108], Float32[0.071226254, 0.10168051, 0.14134367], 3), cost = 188)
(res = KnnResult(Int32[2381, 9519, 565], Float32[0.04062478, 0.07003241, 0.086439826], 3), cost = 222)</code></pre><p>There are a several options for the construction of the index, from specifying the precise searching algorithm (<code>search_algo</code>) and the neighborhood strategy to be used on construction (<code>neighborhood_algo</code>). You can also specify here if the construction will be made in parallel and how this paralllelism will be performed (<code>firstblock</code>, <code>block</code>).</p><article class="docstring"><header><a class="docstring-binding" id="SimilaritySearch.SearchGraph" href="#SimilaritySearch.SearchGraph"><code>SimilaritySearch.SearchGraph</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">struct SearchGraph &lt;: AbstractSearchContext</code></pre><p>SearchGraph index. It stores a set of points that can be compared through a distance function <code>dist</code>. The performance is determined by the search algorithm <code>search_algo</code> and the neighborhood policy. It supports callbacks to adjust parameters as insertions are made.</p><ul><li><code>hints</code>: Initial points for exploration (empty hints imply using random points)</li></ul><p>Note: Parallel insertions should be made through <code>append!</code> or <code>index!</code> function with <code>parallel_block &gt; 1</code></p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/sadit/SimilaritySearch.jl/blob/0e2b750528ce2f5100a18554f55e79dbcbc00f61/src/graph/graph.jl#LL54-L65">source</a></section></article><div class="admonition is-warning"><header class="admonition-header">Missing docstring.</header><div class="admonition-body"><p>Missing docstring for <code>SearchGraphOptions</code>. Check Documenter&#39;s build log for details.</p></div></div><h2 id="Local-search-algorithms"><a class="docs-heading-anchor" href="#Local-search-algorithms">Local search algorithms</a><a id="Local-search-algorithms-1"></a><a class="docs-heading-anchor-permalink" href="#Local-search-algorithms" title="Permalink"></a></h2><p>Regarding the search search algorithm, there are two alternatives, based on local search heuristics.</p><article class="docstring"><header><a class="docstring-binding" id="SimilaritySearch.BeamSearch" href="#SimilaritySearch.BeamSearch"><code>SimilaritySearch.BeamSearch</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">BeamSearch(bsize::Integer=16, Δ::Float32)</code></pre><p>BeamSearch is an iteratively improving local search algorithm that explores the graph using blocks of <code>bsize</code> elements and neighborhoods at the time.</p><ul><li><code>bsize</code>: The size of the beam.</li><li><code>Δ</code>: Soft margin for accepting elements into the beam</li><li><code>maxvisits</code>: MAximum visits while searching, useful for early stopping without convergence</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/sadit/SimilaritySearch.jl/blob/0e2b750528ce2f5100a18554f55e79dbcbc00f61/src/graph/beamsearch.jl#LL6-L14">source</a></section></article><h2 id="Neighborhood-algorithms"><a class="docs-heading-anchor" href="#Neighborhood-algorithms">Neighborhood algorithms</a><a id="Neighborhood-algorithms-1"></a><a class="docs-heading-anchor-permalink" href="#Neighborhood-algorithms" title="Permalink"></a></h2><p>Regarding neighborhood algorithms, the package defines the following ones:</p><p>Neighborhood algorithms</p><div class="admonition is-warning"><header class="admonition-header">Missing docstring.</header><div class="admonition-body"><p>Missing docstring for <code>FixedNeighborhood</code>. Check Documenter&#39;s build log for details.</p></div></div><div class="admonition is-warning"><header class="admonition-header">Missing docstring.</header><div class="admonition-body"><p>Missing docstring for <code>LogNeighborhood</code>. Check Documenter&#39;s build log for details.</p></div></div><div class="admonition is-warning"><header class="admonition-header">Missing docstring.</header><div class="admonition-body"><p>Missing docstring for <code>LogSatNeighborhood</code>. Check Documenter&#39;s build log for details.</p></div></div><article class="docstring"><header><a class="docstring-binding" id="SimilaritySearch.SatNeighborhood" href="#SimilaritySearch.SatNeighborhood"><code>SimilaritySearch.SatNeighborhood</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">SatNeighborhood()</code></pre><p>New items are connected with a small set of items computed with a SAT like scheme (<strong>cite</strong>). It starts with <code>k</code> near items that are reduced to a small neighborhood due to the SAT partitioning stage.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/sadit/SimilaritySearch.jl/blob/0e2b750528ce2f5100a18554f55e79dbcbc00f61/src/graph/neighborhood.jl#LL63-L68">source</a></section></article><h2 id="Incremental-construction-of-the-index"><a class="docs-heading-anchor" href="#Incremental-construction-of-the-index">Incremental construction of the index</a><a id="Incremental-construction-of-the-index-1"></a><a class="docs-heading-anchor-permalink" href="#Incremental-construction-of-the-index" title="Permalink"></a></h2><p>The index supports insertions; for instance, it can be fully constructed using insertions as follows:</p><pre><code class="language- hljs">using SimilaritySearch

index = SearchGraph()

append!(index, [rand(Float32, 4) for i in 1:1000])

search(index, rand(Float32, 4), 3)</code></pre><p>Each insertion is performed by the <code>push!</code> function or a chunk of items with <code>append!</code>; the last function also allows parallel insertions.</p><article class="docstring"><header><a class="docstring-binding" id="Base.push!-Tuple{SearchGraph, Any}" href="#Base.push!-Tuple{SearchGraph, Any}"><code>Base.push!</code></a> — <span class="docstring-category">Method</span></header><section><div><p>push!(index::SearchGraph, item; push_item=true, pools=getpools(index))</p><p>Appends <code>item</code> into the index.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/sadit/SimilaritySearch.jl/blob/0e2b750528ce2f5100a18554f55e79dbcbc00f61/src/graph/graph.jl#LL244-L248">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="Base.append!-Tuple{SearchGraph, Any}" href="#Base.append!-Tuple{SearchGraph, Any}"><code>Base.append!</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">append!(index::SearchGraph, db; parallel_block=1, parallel_minimum_first_block=parallel_block, apply_callbacks=true)</code></pre><p>Appends all items in db to the index. It can be made in parallel or sequentially. In case of a parallel appending, then:</p><ul><li><code>parallel_block</code> must be bigger than 1 and describes the batch size to append in parallel (i.e., in the order of thousands, depending on the size of the <code>db</code> and the number of available threads).</li><li><code>parallel_minimum_first_block</code> indicates the minimum number of items inserted sequentially before going parallel, it can be 0 if the index is already populated, defaults to <code>parallel_block</code>.</li></ul><p>Note: Parallel doesn&#39;t trigger callbacks inside blocks.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/sadit/SimilaritySearch.jl/blob/0e2b750528ce2f5100a18554f55e79dbcbc00f61/src/graph/graph.jl#LL139-L150">source</a></section></article><h3 id="Customizing-the-insertion-method"><a class="docs-heading-anchor" href="#Customizing-the-insertion-method">Customizing the insertion method</a><a id="Customizing-the-insertion-method-1"></a><a class="docs-heading-anchor-permalink" href="#Customizing-the-insertion-method" title="Permalink"></a></h3><p>In particular, the procedure of pushing items into the index is made calling <code>find_neighborhood</code> and <code>push_neighborhood</code>; these methods can be overriden or used in other wyas to customize the insertion of data and the construction of the index.</p><article class="docstring"><header><a class="docstring-binding" id="SimilaritySearch.find_neighborhood" href="#SimilaritySearch.find_neighborhood"><code>SimilaritySearch.find_neighborhood</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">find_neighborhood(index::SearchGraph{T}, item, pools; hints=index.hints)</code></pre><p>Searches for <code>item</code> neighborhood in the index, i.e., if <code>item</code> were in the index whose items should be its neighbors (intenal function). <code>res</code> is always reused since <code>reduce</code> creates a new KnnResult from it (a copy if <code>reduce</code> in its simpler terms)</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/sadit/SimilaritySearch.jl/blob/0e2b750528ce2f5100a18554f55e79dbcbc00f61/src/graph/neighborhood.jl#LL14-L19">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="SimilaritySearch.push_neighborhood!" href="#SimilaritySearch.push_neighborhood!"><code>SimilaritySearch.push_neighborhood!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">push_neighborhood!(index::SearchGraph, item, neighbors; push_item=true, apply_callbacks=true)</code></pre><p>Inserts the object <code>item</code> into the index, i.e., creates an edge from items listed in L and the vertex created for ìtem` (internal function)</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/sadit/SimilaritySearch.jl/blob/0e2b750528ce2f5100a18554f55e79dbcbc00f61/src/graph/neighborhood.jl#LL31-L36">source</a></section></article><h3 id="Optimizing-the-index&#39;s-performance"><a class="docs-heading-anchor" href="#Optimizing-the-index&#39;s-performance">Optimizing the index&#39;s performance</a><a id="Optimizing-the-index&#39;s-performance-1"></a><a class="docs-heading-anchor-permalink" href="#Optimizing-the-index&#39;s-performance" title="Permalink"></a></h3><article class="docstring"><header><a class="docstring-binding" id="SimilaritySearch.optimize!" href="#SimilaritySearch.optimize!"><code>SimilaritySearch.optimize!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">optimize!(
    index::SearchGraph,
    opt::OptimizeParameters;
    queries=nothing,
    scalemaxvisits=1.0,
    maxvisits=2 * index.search_algo.maxvisits,
    verbose=index.verbose
)</code></pre><p>Optimizes the index using the <code>opt</code> parameters. If <code>queries=nothing</code> then it selects a small sample randomply from  the already indexed objects; this sample size and the number of neighbors are also parameters in <code>opt</code>.</p><p>Note: The <code>visits</code> parameters is a factor allowing early stopping based on the number of distance evaluations seen in the optimization procedure; please note that in some cases this will reduce the quality to limit the search times. Please also take into account that inserting items after limiting visits may also cause severe quality degradation when maxvisits is not also updated as required. You can always adjust maxvisits modifying <code>index.search_algo.maxvisits</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/sadit/SimilaritySearch.jl/blob/0e2b750528ce2f5100a18554f55e79dbcbc00f61/src/graph/opt.jl#LL106-L122">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../searching/">« Searching</a><a class="docs-footer-nextpage" href="../knnresult/">Knn results »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.14 on <span class="colophon-date" title="Friday 4 March 2022 19:54">Friday 4 March 2022</span>. Using Julia version 1.7.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
